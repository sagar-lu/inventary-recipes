<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cocina Mexicana & Chefcito</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* ================= APPLE SYSTEM FONTS & LIQUID THEME ================= */
        :root {
            --glass-border-light: rgba(255, 255, 255, 0.6);
            --glass-border-dark: rgba(255, 255, 255, 0.2);
            --glass-surface: rgba(255, 255, 255, 0.65); 
            --active-blue: #007AFF;
        }
        
        body {
            /* Stack de fuentes nativo de Apple ajustado */
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: #F2F2F7;
            color: #1D1D1F;
            padding-bottom: 120px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            overscroll-behavior-y: none;
        }

        /* ================= FONDO L√çQUIDO DIN√ÅMICO (LAVA MESH) ================= */
        .liquid-background {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -1;
            background: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
            overflow: hidden;
        }
        
        /* Orbes de color que se mezclan */
        .blob {
            position: absolute;
            filter: blur(80px);
            opacity: 0.7;
            animation: blob-bounce 15s infinite ease-in-out alternate;
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
        }
        .blob-1 { top: -10%; left: -10%; width: 70vw; height: 70vw; background: #FFD60A; animation-delay: 0s; }
        .blob-2 { bottom: -10%; right: -10%; width: 70vw; height: 70vw; background: #FF9F0A; animation-delay: -4s; animation-direction: alternate-reverse; }
        .blob-3 { top: 40%; left: 40%; width: 60vw; height: 60vw; background: #a8c0ff; opacity: 0.4; animation-delay: -8s; }

        @keyframes blob-bounce {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); }
            50% { transform: translate(20px, 30px) rotate(10deg) scale(1.1); border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
            100% { transform: translate(-20px, -20px) rotate(-5deg) scale(0.95); }
        }

        /* ================= EFECTO LIQUID GLASS REAL ================= */
        .glass-panel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.4));
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            /* Borde degradado para simular luz incidente desde arriba */
            border-top: 1px solid var(--glass-border-light);
            border-left: 1px solid var(--glass-border-light);
            border-bottom: 1px solid var(--glass-border-dark);
            border-right: 1px solid var(--glass-border-dark);
            box-shadow: 
                0 8px 32px 0 rgba(31, 38, 135, 0.05),
                inset 0 0 0 1px rgba(255, 255, 255, 0.1);
            position: relative;
            transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.2s ease;
        }

        .glass-panel:active {
            transform: scale(0.98);
        }

        /* Banner con efecto de profundidad extra */
        .glass-banner {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 15px 35px -5px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }

        /* ================= UI ELEMENTS ================= */
        
        /* Header Compacto */
        .header-compact {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(30px) saturate(180%);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 20px rgba(0,0,0,0.02);
        }

        /* Inputs "Liquid" m√°s sutiles */
        .liquid-input {
            background: rgba(118, 118, 128, 0.12); /* Color nativo de input iOS */
            border: none;
            backdrop-filter: none;
            transition: all 0.3s ease;
            color: #1D1D1F;
        }
        .liquid-input:focus {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 0 2px var(--active-blue);
        }
        .liquid-input::placeholder { color: #8E8E93; }

        /* Iconos Apple Style con gradientes */
        .apple-icon {
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.35rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.3);
            position: relative; overflow: hidden;
        }
        /* Brillo interno (shimmer) */
        .apple-icon::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.3), transparent);
            transform: skewX(-25deg);
            animation: shimmer 6s infinite;
        }
        @keyframes shimmer {
            0%, 90% { left: -100%; }
            100% { left: 200%; }
        }
        
        .grad-red { background: linear-gradient(135deg, #FF3B30, #FF9500); }
        .grad-green { background: linear-gradient(135deg, #34C759, #30B0C7); }
        .grad-orange { background: linear-gradient(135deg, #FF9500, #FFCC00); }
        .grad-blue { background: linear-gradient(135deg, #007AFF, #5AC8FA); }
        .grad-purple { background: linear-gradient(135deg, #AF52DE, #5856D6); }
        .grad-gray { background: linear-gradient(135deg, #8E8E93, #AEAEB2); }

        /* Estado seleccionado Inventory */
        .inventory-item-selected {
            background-color: rgba(255, 255, 255, 0.95) !important;
            border: 1.5px solid var(--active-blue) !important;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.2) !important;
        }
        .inventory-item-selected .icon-display {
            filter: none !important; transform: scale(1.1);
        }
        .inventory-item-selected .check-badge {
            opacity: 1 !important; transform: scale(1) !important;
        }

        /* Bot√≥n M√°gico (IA) con animaci√≥n l√≠quida */
        .btn-magic {
            background: linear-gradient(110deg, #007AFF, #5856D6, #FF2D55);
            background-size: 200% 200%;
            animation: gradientMove 4s ease infinite;
            color: white;
            box-shadow: 0 8px 20px -4px rgba(0, 122, 255, 0.4);
            border: 1px solid rgba(255,255,255,0.2);
        }
        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Nav Glass Flotante */
        .nav-glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .bottom-nav-item { transition: color 0.2s; }
        .bottom-nav-item.active { color: var(--active-blue); }

        /* Chat */
        .chat-bubble-user {
            background: var(--active-blue); color: white;
            border-radius: 20px 20px 4px 20px;
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.2);
        }
        .chat-bubble-ai {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            color: #1D1D1F;
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 20px 20px 20px 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .rounded-super { border-radius: 24px; }
        .rounded-ios { border-radius: 14px; } /* Radio est√°ndar iOS */
        
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
    </style>
</head>
<body>

    <!-- Fondo L√≠quido Animado -->
    <div class="liquid-background">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- ================= HEADER (Redise√±ado Compacto) ================= -->
    <!-- Ahora se integra con el fondo pero mantiene legibilidad -->
    <header class="sticky top-0 z-50 header-compact px-4 py-2 transition-all duration-300">
        <div class="max-w-2xl mx-auto flex items-center justify-between mb-2 pt-1">
            <div>
                <p class="text-[10px] uppercase tracking-widest text-gray-500 font-bold opacity-80">Bienvenido</p>
                <h1 class="text-xl font-bold text-gray-900 tracking-tight">Mi Cocina</h1>
            </div>
            <div class="w-9 h-9 rounded-full bg-gradient-to-b from-gray-100 to-white border border-white/50 shadow-sm flex items-center justify-center">
                <i class="fas fa-user text-gray-400 text-xs"></i>
            </div>
        </div>
        
        <!-- Buscador Sutil (Estilo iOS Spotlight) -->
        <div class="max-w-2xl mx-auto relative pb-1">
            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-sm z-10"></i>
            <input type="text" id="global-search" placeholder="Buscar (ej. tacos, pollo)..." 
                   class="liquid-input w-full rounded-ios py-2 pl-9 pr-8 text-[15px] leading-relaxed focus:outline-none placeholder-gray-500">
            <button id="clear-search" onclick="limpiarBusqueda()" class="hidden absolute right-2.5 top-2.5 text-gray-400 hover:text-gray-600 bg-gray-200 rounded-full w-5 h-5 flex items-center justify-center">
                <i class="fas fa-times text-[10px]"></i>
            </button>
        </div>
    </header>

    <!-- ================= MAIN CONTENT ================= -->
    <main id="app-content" class="p-4 max-w-2xl mx-auto fade-in min-h-screen pt-4">
        <!-- Contenido Din√°mico -->
    </main>

    <!-- ================= NAVIGATION (Flotante Glass) ================= -->
    <nav class="fixed bottom-6 left-4 right-4 nav-glass rounded-[32px] px-1 py-1 flex justify-between items-center z-50 md:w-full md:max-w-md md:mx-auto backdrop-blur-xl">
        <button onclick="router('home')" class="bottom-nav-item active flex flex-col items-center justify-center w-16 h-14 text-gray-400/80 hover:text-gray-500 transition-all" id="nav-home">
            <i class="fas fa-home text-xl mb-0.5"></i>
            <span class="text-[9px] font-medium tracking-wide">Inicio</span>
        </button>
        
        <button onclick="router('inventory')" class="bottom-nav-item flex flex-col items-center justify-center w-16 h-14 text-gray-400/80 hover:text-gray-500 transition-all" id="nav-inventory">
            <i class="fas fa-box-open text-xl mb-0.5"></i>
            <span class="text-[9px] font-medium tracking-wide">Despensa</span>
        </button>
        
        <!-- Bot√≥n Central IA (Flotante) -->
        <div class="relative -top-6">
            <button onclick="router('ai-chef')" class="w-14 h-14 rounded-full btn-magic flex items-center justify-center shadow-2xl transform transition-transform hover:scale-105 active:scale-95 ring-4 ring-[#F2F2F7]">
                <i class="fas fa-wand-magic-sparkles text-xl"></i>
            </button>
            <span class="absolute -bottom-4 left-1/2 transform -translate-x-1/2 text-[9px] font-bold text-gray-500 tracking-wide">Chefcito</span>
        </div>
        
        <button onclick="router('recipes')" class="bottom-nav-item flex flex-col items-center justify-center w-16 h-14 text-gray-400/80 hover:text-gray-500 transition-all" id="nav-recipes">
            <i class="fas fa-book-open text-xl mb-0.5"></i>
            <span class="text-[9px] font-medium tracking-wide">Recetas</span>
        </button>
        
        <button onclick="router('favorites')" class="bottom-nav-item flex flex-col items-center justify-center w-16 h-14 text-gray-400/80 hover:text-gray-500 transition-all" id="nav-favorites">
            <i class="fas fa-heart text-xl mb-0.5"></i>
            <span class="text-[9px] font-medium tracking-wide">Favs</span>
        </button>
    </nav>

    <!-- ================= SCRIPTS ================= -->
    <script>
        // ================= API KEY =================
        const apiKey = ""; // Pega tu API Key aqu√≠

        async function callGeminiAPI(userPrompt) {
            if (!apiKey) return "¬°Ups! Falta la API Key. Config√∫rala en el c√≥digo.";

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const inventarioActual = Array.from(miInventario).map(id => obtenerNombreIngrediente(id)).join(', ');
            
            const systemContext = `
                Eres "Chefcito", un asistente de cocina mexicano experto y divertido.
                Contexto: Ingredientes disponibles: ${inventarioActual || "Ninguno"}.
                Instrucciones: S√© breve, usa Markdown, prioriza recetas posibles.
            `;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemContext }] }
                    })
                });
                if (!response.ok) throw new Error('Error API');
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (e) {
                return "Error de conexi√≥n con Chefcito.";
            }
        }

        // ================= DATOS =================
        const categoriasInventario = [
            { id: 'frutas', nombre: 'Frutas', icon: 'fa-apple-alt', gradient: 'grad-red' },
            { id: 'verduras', nombre: 'Verduras', icon: 'fa-carrot', gradient: 'grad-green' },
            { id: 'proteinas', nombre: 'Prote√≠na', icon: 'fa-drumstick-bite', gradient: 'grad-orange' },
            { id: 'lacteos', nombre: 'L√°cteos', icon: 'fa-cheese', gradient: 'grad-blue' },
            { id: 'despensa', nombre: 'Despensa', icon: 'fa-bread-slice', gradient: 'grad-purple' },
            { id: 'otros', nombre: 'Otros', icon: 'fa-utensils', gradient: 'grad-gray' }
        ];

        const ingredientesComunesDB = [
            { id: 'pollo', nombre: 'Pollo', cat: 'proteinas' }, { id: 'res', nombre: 'Res', cat: 'proteinas' },
            { id: 'cerdo', nombre: 'Cerdo', cat: 'proteinas' }, { id: 'huevo', nombre: 'Huevo', cat: 'proteinas' },
            { id: 'jamon', nombre: 'Jam√≥n', cat: 'proteinas' }, { id: 'salchicha', nombre: 'Salchicha', cat: 'proteinas' },
            { id: 'camaron', nombre: 'Camar√≥n', cat: 'proteinas' }, { id: 'tomate', nombre: 'Tomate', cat: 'verduras' },
            { id: 'tomate_verde', nombre: 'Tomate Verde', cat: 'verduras' }, { id: 'cebolla', nombre: 'Cebolla', cat: 'verduras' },
            { id: 'ajo', nombre: 'Ajo', cat: 'verduras' }, { id: 'chile', nombre: 'Chiles', cat: 'verduras' },
            { id: 'elote', nombre: 'Elote', cat: 'verduras' }, { id: 'cilantro', nombre: 'Cilantro', cat: 'verduras' },
            { id: 'lechuga', nombre: 'Lechuga', cat: 'verduras' }, { id: 'aguacate', nombre: 'Aguacate', cat: 'frutas' },
            { id: 'limon', nombre: 'Lim√≥n', cat: 'frutas' }, { id: 'pi√±a', nombre: 'Pi√±a', cat: 'frutas' },
            { id: 'tortillas', nombre: 'Tortillas', cat: 'despensa' }, { id: 'maiz_pozolero', nombre: 'Ma√≠z Pozolero', cat: 'despensa' },
            { id: 'frijoles', nombre: 'Frijoles', cat: 'despensa' }, { id: 'arroz', nombre: 'Arroz', cat: 'despensa' },
            { id: 'pan', nombre: 'Pan', cat: 'despensa' }, { id: 'tostadas', nombre: 'Tostadas', cat: 'despensa' },
            { id: 'fideos', nombre: 'Fideos', cat: 'despensa' }, { id: 'masa', nombre: 'Masa', cat: 'despensa' },
            { id: 'aceite', nombre: 'Aceite', cat: 'despensa' }, { id: 'pasta', nombre: 'Pasta', cat: 'despensa' },
            { id: 'achiote', nombre: 'Achiote', cat: 'despensa' }, { id: 'queso', nombre: 'Queso', cat: 'lacteos' },
            { id: 'crema', nombre: 'Crema', cat: 'lacteos' }, { id: 'leche', nombre: 'Leche', cat: 'lacteos' }
        ];

        const recetasMexicanas = [
            { id: 1, nombre: "Huevos Rancheros", descripcion: "Huevos sobre tortilla con salsa roja.", imagen: "https://images.unsplash.com/photo-1621516039535-649dfeb8c544?auto=format&fit=crop&w=600&q=80", tiempo: 15, dificultad: "F√°cil", categoria: "Desayuno", ingredientesBase: ["huevo", "tortillas", "tomate", "cebolla", "chile", "aceite"], instrucciones: ["Salsa roja b√°sica.", "Tortillas pasadas por aceite.", "Huevos estrellados.", "Montar."], tips: ["Epazote en la salsa."] },
            { id: 2, nombre: "Molletes", descripcion: "Bolillo con frijoles y queso gratinado.", imagen: "https://images.unsplash.com/photo-1628190760360-32b005e83924?auto=format&fit=crop&w=600&q=80", tiempo: 15, dificultad: "Muy F√°cil", categoria: "Desayuno", ingredientesBase: ["pan", "frijoles", "queso"], instrucciones: ["Cortar pan.", "Untar frijoles.", "Queso y gratinar.", "Pico de gallo."], tips: ["A√±ade chorizo."] },
            { id: 3, nombre: "Enfrijoladas", descripcion: "Tortillas en salsa de frijol.", imagen: "https://images.unsplash.com/photo-1652545208648-34016132d153?auto=format&fit=crop&w=600&q=80", tiempo: 20, dificultad: "F√°cil", categoria: "Comida", ingredientesBase: ["tortillas", "frijoles", "queso", "crema", "cebolla"], instrucciones: ["Salsa de frijol.", "Suavizar tortillas.", "Ba√±ar y doblar."], tips: ["Chipotle a la salsa."] },
            { id: 4, nombre: "Guacamole", descripcion: "Dip de aguacate.", imagen: "https://images.unsplash.com/photo-1594911769850-8b634ac8f2b7?auto=format&fit=crop&w=600&q=80", tiempo: 10, dificultad: "Muy F√°cil", categoria: "Botana", ingredientesBase: ["aguacate", "tomate", "cebolla", "cilantro", "limon", "chile"], instrucciones: ["Picar verdura.", "Machacar aguacate.", "Mezclar."], tips: ["Hueso para conservar."] },
            { id: 5, nombre: "Sincronizadas", descripcion: "Tortilla con jam√≥n y queso.", imagen: "https://images.unsplash.com/photo-1626700051175-6818013e1d4f?auto=format&fit=crop&w=600&q=80", tiempo: 10, dificultad: "Muy F√°cil", categoria: "Cena", ingredientesBase: ["tortillas", "jamon", "queso"], instrucciones: ["Armar quesadilla.", "Calentar.", "Cortar."], tips: ["Con guacamole."] },
            { id: 6, nombre: "Tostadas de Pollo", descripcion: "Tostada con pollo y crema.", imagen: "https://images.unsplash.com/photo-1550951662-75d8d3886f44?auto=format&fit=crop&w=600&q=80", tiempo: 25, dificultad: "F√°cil", categoria: "Comida", ingredientesBase: ["tortillas", "pollo", "frijoles", "lechuga", "crema", "queso"], instrucciones: ["Tostada frita.", "Frijoles.", "Pollo y toppings."], tips: ["Lechuga seca."] },
            { id: 7, nombre: "Sopa de Tortilla", descripcion: "Caldo de tomate con tiras fritas.", imagen: "https://images.unsplash.com/photo-1577308856961-8e9ec50d0c67?auto=format&fit=crop&w=600&q=80", tiempo: 35, dificultad: "Media", categoria: "Sopa", ingredientesBase: ["tortillas", "tomate", "cebolla", "ajo", "aguacate", "queso", "crema", "aceite"], instrucciones: ["Fre√≠r tiras.", "Caldillo tomate.", "Servir."], tips: ["Tiras aparte."] },
            { id: 8, nombre: "Chilaquiles Verdes", descripcion: "Totopos en salsa verde.", imagen: "https://images.unsplash.com/photo-1640719028782-4f36a537f02b?auto=format&fit=crop&w=600&q=80", tiempo: 30, dificultad: "Media", categoria: "Desayuno", ingredientesBase: ["tortillas", "tomate_verde", "cebolla", "chile", "cilantro", "pollo", "crema", "queso"], instrucciones: ["Totopos.", "Salsa verde.", "Mezclar."], tips: ["Servir r√°pido."] },
            { id: 11, nombre: "Pozole Rojo", descripcion: "Caldo con cerdo y ma√≠z.", imagen: "https://images.unsplash.com/photo-1606787947360-4181ea538757?auto=format&fit=crop&w=600&q=80", tiempo: 120, dificultad: "Dif√≠cil", categoria: "Comida", ingredientesBase: ["maiz_pozolero", "cerdo", "chile", "lechuga", "rabano", "limon"], instrucciones: ["Cocer ma√≠z.", "Cocer carne.", "Salsa guajillo.", "Juntar."], tips: ["Cabeza de lomo."] },
            { id: 13, nombre: "Esquites", descripcion: "Elote cocido preparado.", imagen: "https://images.unsplash.com/photo-1625938145744-e38051524e2c?auto=format&fit=crop&w=600&q=80", tiempo: 45, dificultad: "F√°cil", categoria: "Botana", ingredientesBase: ["elote", "cebolla", "chile", "limon", "mayonesa", "queso"], instrucciones: ["Sofr√≠e cebolla.", "Cocer elote.", "Servir preparado."], tips: ["Epazote."] }
        ];

        let miInventario = new Set();
        let misFavoritos = new Set();
        let recetasMostradas = 6; 

        // ================= ROUTER =================
        function router(view) {
            const searchInput = document.getElementById('global-search');
            const appContent = document.getElementById('app-content');
            
            document.querySelectorAll('.bottom-nav-item').forEach(el => el.classList.remove('active', 'text-[#007AFF]'));
            const activeBtn = document.getElementById(`nav-${view}`);
            if(activeBtn) activeBtn.classList.add('active', 'text-[#007AFF]');

            appContent.innerHTML = ''; 
            window.scrollTo({ top: 0, behavior: 'auto' });

            // L√≥gica de limpieza de buscador (si no es b√∫squeda expl√≠cita)
            if(view !== 'recipes' || (searchInput.value === '')) {
               // Opcional: limpiar si cambiamos de tab
            }

            switch(view) {
                case 'home': 
                    searchInput.value = ''; 
                    document.getElementById('clear-search').classList.add('hidden');
                    renderHome(appContent); break;
                case 'inventory': 
                    searchInput.value = ''; 
                    document.getElementById('clear-search').classList.add('hidden');
                    renderInventory(appContent); break;
                case 'recipes': renderRecipes(appContent); break;
                case 'favorites': 
                    searchInput.value = ''; 
                    document.getElementById('clear-search').classList.add('hidden');
                    renderFavorites(appContent); break;
                case 'ai-chef': renderAI(appContent); break;
                default: renderHome(appContent);
            }
            
            appContent.classList.remove('fade-in');
            void appContent.offsetWidth; 
            appContent.classList.add('fade-in');
        }

        // ================= VIEWS =================
        function renderHome(container) {
            container.innerHTML = `
                <!-- Banner Mejorado -->
                <div class="glass-banner rounded-super p-0 mb-6 relative h-48 flex items-center overflow-hidden cursor-pointer group active:scale-[0.99] transition-all" onclick="router('inventory')">
                    <div class="absolute inset-0">
                        <img src="https://images.unsplash.com/photo-1606787366850-de6330128bfc?auto=format&fit=crop&w=800&q=80" class="w-full h-full object-cover opacity-90 transition-transform duration-1000 group-hover:scale-105">
                        <div class="absolute inset-0 bg-gradient-to-r from-white/95 via-white/60 to-transparent"></div>
                    </div>
                    <div class="relative z-10 pl-6 pr-4 w-3/4">
                        <span class="text-[10px] font-bold text-orange-500 tracking-widest uppercase mb-1 block">Tu Espacio</span>
                        <h2 class="text-3xl font-bold text-gray-900 leading-tight tracking-tight mb-1">Inventario<br>Inteligente</h2>
                        <p class="text-gray-600 text-xs font-medium mt-1">Gestiona lo que tienes en casa</p>
                    </div>
                </div>

                <!-- Categor√≠as -->
                <div class="flex justify-between items-center mb-3 px-1">
                    <h3 class="font-bold text-lg text-gray-900 tracking-tight">Categor√≠as</h3>
                    <button onclick="router('inventory')" class="text-blue-500 text-xs font-semibold">Ver todo</button>
                </div>
                <div class="grid grid-cols-4 gap-3 mb-6">
                    ${categoriasInventario.slice(0,4).map(cat => `
                        <div class="flex flex-col items-center gap-1.5 cursor-pointer group" onclick="router('inventory')">
                            <div class="w-[58px] h-[58px] rounded-[18px] apple-icon ${cat.gradient} group-active:scale-90 transition-transform duration-200">
                                <i class="fas ${cat.icon} text-xl"></i>
                            </div>
                            <span class="text-[10px] font-medium text-gray-500 text-center tracking-tight">${cat.nombre}</span>
                        </div>
                    `).join('')}
                </div>

                <!-- Recetas -->
                <div class="flex justify-between items-center mb-3 px-1 mt-4">
                    <h3 class="font-bold text-lg text-gray-900 tracking-tight">Para ti</h3>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    ${recetasMexicanas.slice(0, 3).map(receta => renderRecipeCard(receta)).join('')}
                </div>
            `;
        }

        function renderInventory(container) {
            const totalItems = miInventario.size;
            container.innerHTML = `
                <div class="glass-panel sticky top-0 z-20 rounded-2xl p-3 mb-5 flex justify-between items-center backdrop-blur-xl bg-white/80 border border-white/60 shadow-sm">
                    <div><h2 class="text-xl font-bold text-gray-900">Mi Despensa</h2><p class="text-[10px] text-gray-500 font-medium">Toca para activar</p></div>
                    <div class="flex gap-2 items-center">
                        <button onclick="generarRecetaMagica()" class="btn-magic px-3 py-1.5 rounded-full text-[10px] font-bold shadow-lg flex items-center gap-1 active:scale-95 transition-transform uppercase tracking-wide"><i class="fas fa-wand-magic-sparkles"></i> Crear</button>
                        <div class="bg-gray-900 text-white px-3 py-1.5 rounded-full text-[10px] font-bold" id="inventory-counter">${totalItems}</div>
                    </div>
                </div>
                <div class="space-y-6 pb-20">
                    ${categoriasInventario.map(cat => {
                        const ings = ingredientesComunesDB.filter(i => i.cat === cat.id);
                        if (ings.length === 0) return '';
                        return `
                        <div>
                            <div class="flex items-center gap-2 mb-2 pl-1 opacity-80">
                                <i class="fas ${cat.icon} text-xs text-gray-400"></i>
                                <h3 class="font-bold text-gray-700 text-xs tracking-wide uppercase">${cat.nombre}</h3>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                ${ings.map(ing => {
                                    const isSelected = miInventario.has(ing.id);
                                    return `
                                    <div id="ing-card-${ing.id}" class="glass-panel h-24 rounded-2xl flex flex-col items-center justify-center p-1 cursor-pointer transition-all duration-200 select-none relative ${isSelected ? 'inventory-item-selected' : 'bg-white/40'}" onclick="toggleInventario('${ing.id}')">
                                        <div class="text-2xl mb-1 icon-display transition-transform duration-200 ${isSelected ? '' : 'grayscale opacity-50'}">${getIconForIngredient(ing.id)}</div>
                                        <span class="text-[10px] font-semibold text-center leading-tight ${isSelected ? 'text-gray-900' : 'text-gray-400'} name-display">${ing.nombre}</span>
                                        <div class="check-badge absolute top-1.5 right-1.5 text-blue-500 text-xs transition-all duration-200 ${isSelected ? 'opacity-100 scale-100' : 'opacity-0 scale-0'}"><i class="fas fa-check-circle"></i></div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            `;
        }

        function renderRecipes(container, inputLista = null) {
            const searchInput = document.getElementById('global-search');
            const busqueda = searchInput ? searchInput.value.toLowerCase().trim() : '';
            let lista = inputLista || recetasMexicanas;

            if (busqueda) {
                document.getElementById('clear-search').classList.remove('hidden');
                lista = lista.filter(r => r.nombre.toLowerCase().includes(busqueda) || r.ingredientesBase.some(i => i.toLowerCase().includes(busqueda)));
            } else {
                document.getElementById('clear-search').classList.add('hidden');
            }

            lista.sort((a, b) => calcularCoincidencia(b).porcentaje - calcularCoincidencia(a).porcentaje);
            const visibleList = lista.slice(0, recetasMostradas);

            container.innerHTML = `
                <div class="mb-4 flex justify-between items-end">
                    <h2 class="text-xl font-bold text-gray-900 tracking-tight">${busqueda ? 'Resultados' : (inputLista ? 'Mis Favoritos' : 'Recetario')}</h2>
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">${lista.length} recetas</span>
                </div>
                <div class="grid grid-cols-1 gap-4" id="recipe-grid">
                    ${visibleList.map(receta => renderRecipeCard(receta)).join('')}
                </div>
                ${visibleList.length === 0 ? `<div class="text-center py-12 opacity-50 text-sm font-medium">No encontramos recetas.</div>` : ''}
                ${lista.length > recetasMostradas ? `<div class="mt-8 text-center pb-4"><button onclick="cargarMasRecetas()" class="btn-liquid px-6 py-2 rounded-full text-[10px] font-bold uppercase tracking-widest shadow-lg">Ver m√°s</button></div>` : ''}
            `;
        }

        function renderAI(container) {
            container.innerHTML = `
                <div class="h-[calc(100vh-150px)] flex flex-col relative">
                    <div class="glass-panel rounded-[24px] flex-1 flex flex-col overflow-hidden shadow-xl border border-white/60 bg-white/40 backdrop-blur-md">
                        <div class="bg-white/80 backdrop-blur-md p-3 border-b border-white/50 flex items-center gap-3 z-10">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 flex items-center justify-center text-white shadow-md"><i class="fas fa-wand-magic-sparkles text-xs"></i></div>
                            <div><h3 class="font-bold text-gray-900 text-sm">Chefcito</h3><p class="text-[9px] text-blue-500 font-bold uppercase tracking-wider">AI Assistant</p></div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-4 scroll-smooth" id="chat-messages">
                            <div class="flex items-end gap-2 max-w-[90%]">
                                <div class="chat-bubble-ai p-3 text-sm shadow-sm text-gray-800 leading-relaxed">¬°Hola! Soy Chefcito üç≥. Veo que tienes <b>${miInventario.size} ingredientes</b>. ¬øQu√© cocinamos hoy?</div>
                            </div>
                        </div>
                        <div class="p-3 bg-white/60 border-t border-white/50 relative backdrop-blur-md">
                            <form onsubmit="handleRealAIChat(event)" class="relative z-10">
                                <input type="text" id="ai-input" placeholder="Ej: Algo r√°pido con pollo..." autocomplete="off" class="w-full bg-white rounded-full py-2.5 pl-4 pr-10 text-sm focus:outline-none shadow-inner border border-gray-100 text-gray-800 placeholder-gray-400">
                                <button type="submit" class="absolute right-2 top-1.5 w-7 h-7 bg-blue-500 rounded-full flex items-center justify-center text-white shadow-md active:scale-90"><i class="fas fa-arrow-up text-[10px]"></i></button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        // ================= LOGIC & HELPERS =================
        function renderRecipeCard(receta) {
            const coincidencia = calcularCoincidencia(receta);
            const pct = Math.round(coincidencia.porcentaje);
            let color = pct > 75 ? 'bg-[#32D74B]' : (pct > 40 ? 'bg-yellow-400' : 'bg-red-400');
            
            return `
                <div class="glass-panel p-2.5 rounded-[20px] flex gap-3 cursor-pointer hover:bg-white/50 transition-colors group relative active:scale-[0.99]" onclick="mostrarDetalleReceta(${receta.id})">
                    <div class="w-24 h-24 rounded-2xl bg-gray-100 overflow-hidden flex-shrink-0 shadow-sm relative">
                        <img src="${receta.imagen}" class="w-full h-full object-cover" loading="lazy">
                    </div>
                    <div class="flex-1 flex flex-col justify-center py-0.5 pr-1">
                        <div class="flex justify-between items-start mb-0.5">
                            <h4 class="font-bold text-sm text-gray-900 leading-tight">${receta.nombre}</h4>
                            <button class="p-1 -mr-1 -mt-1 active:scale-90 transition-transform" onclick="event.stopPropagation(); toggleFavorito(${receta.id}, this)">
                                <i class="${misFavoritos.has(receta.id) ? 'fas text-red-500' : 'far text-gray-400'} fa-heart"></i>
                            </button>
                        </div>
                        <p class="text-[10px] text-gray-500 line-clamp-2 mb-2 leading-relaxed">${receta.descripcion}</p>
                        <div class="mt-auto">
                            <div class="flex justify-between text-[9px] mb-1 font-bold uppercase tracking-wide text-gray-400">
                                <span>${coincidencia.encontrados}/${coincidencia.total} Ingredientes</span>
                                <span class="${pct === 100 ? 'text-green-600' : ''}">${pct}%</span>
                            </div>
                            <div class="w-full h-1 bg-gray-200 rounded-full overflow-hidden"><div class="${color} h-full rounded-full" style="width: ${pct}%"></div></div>
                        </div>
                    </div>
                </div>`;
        }

        // Logic handlers (sin cambios funcionales, solo visuales)
        function toggleInventario(id) {
            const card = document.getElementById(`ing-card-${id}`);
            if (miInventario.has(id)) { miInventario.delete(id); if(card) updateCardStyle(card, false); } 
            else { miInventario.add(id); if(card) updateCardStyle(card, true); }
            const counter = document.getElementById('inventory-counter');
            if(counter) { counter.innerText = miInventario.size; counter.classList.add('scale-110'); setTimeout(()=>counter.classList.remove('scale-110'), 200); }
        }
        function updateCardStyle(card, selected) {
            if(selected) {
                card.className = card.className.replace('bg-white/40', 'inventory-item-selected');
                card.querySelector('.icon-display').classList.remove('grayscale', 'opacity-50');
                card.querySelector('.name-display').classList.replace('text-gray-400', 'text-gray-900');
                card.querySelector('.check-badge').classList.replace('opacity-0', 'opacity-100');
                card.querySelector('.check-badge').classList.replace('scale-0', 'scale-100');
                if(navigator.vibrate) navigator.vibrate(10);
            } else {
                card.className = card.className.replace('inventory-item-selected', 'bg-white/40');
                card.querySelector('.icon-display').classList.add('grayscale', 'opacity-50');
                card.querySelector('.name-display').classList.replace('text-gray-900', 'text-gray-400');
                card.querySelector('.check-badge').classList.replace('opacity-100', 'opacity-0');
                card.querySelector('.check-badge').classList.replace('scale-100', 'scale-0');
            }
        }
        function toggleFavorito(id, btn) {
            const icon = btn.querySelector('i');
            if(misFavoritos.has(id)) { misFavoritos.delete(id); icon.className = 'far fa-heart text-gray-400'; }
            else { misFavoritos.add(id); icon.className = 'fas fa-heart text-red-500 drop-shadow-sm'; icon.style.transform='scale(1.3)'; setTimeout(()=>icon.style.transform='scale(1)', 200); }
        }
        function calcularCoincidencia(receta) {
            let enc = 0, falt = [];
            receta.ingredientesBase.forEach(i => miInventario.has(i) ? enc++ : falt.push(i));
            return { total: receta.ingredientesBase.length, encontrados: enc, faltantes: falt, porcentaje: (enc/receta.ingredientesBase.length)*100 };
        }
        function getIconForIngredient(id) { return ({'pollo':'üçó','res':'ü•©','cerdo':'üçñ','huevo':'ü•ö','jamon':'ü•ì','salchicha':'üå≠','camaron':'ü¶ê','tomate':'üçÖ','tomate_verde':'üü¢','cebolla':'üßÖ','ajo':'üßÑ','chile':'üå∂Ô∏è','elote':'üåΩ','cilantro':'üåø','lechuga':'ü•¨','aguacate':'ü•ë','limon':'üçã','pi√±a':'üçç','tortillas':'ü´ì','maiz_pozolero':'üåΩ','frijoles':'ü´ò','arroz':'üçö','pan':'ü•ñ','tostadas':'üçò','fideos':'üçú','queso':'üßÄ','crema':'ü•õ','leche':'ü•õ'})[id] || 'ü•ò'; }
        function obtenerNombreIngrediente(id) { const i = ingredientesComunesDB.find(x => x.id === id); return i ? i.nombre : id; }
        function mostrarDetalleReceta(id) {
            const r = recetasMexicanas.find(x => x.id === id);
            const c = calcularCoincidencia(r);
            Swal.fire({
                html: `<div class="text-left -mx-5 -mt-5 relative"><div class="h-64 relative"><img src="${r.imagen}" class="w-full h-full object-cover"><button onclick="Swal.close()" class="absolute top-3 left-3 w-8 h-8 bg-black/20 backdrop-blur-md rounded-full text-white flex items-center justify-center"><i class="fas fa-times"></i></button><div class="absolute bottom-0 w-full p-5 text-white bg-gradient-to-t from-black/80 to-transparent"><span class="text-[10px] font-bold bg-blue-500/80 px-2 py-0.5 rounded uppercase tracking-wider">${r.categoria}</span><h2 class="text-2xl font-bold mt-1 leading-tight">${r.nombre}</h2></div></div><div class="p-5 bg-white relative rounded-t-[24px] -mt-4"><div class="flex justify-between mb-4 text-center text-gray-500"><div class="flex-1 border-r"><i class="far fa-clock text-orange-500"></i><p class="text-xs font-bold text-gray-800">${r.tiempo}'</p></div><div class="flex-1"><i class="fas fa-chart-bar text-green-500"></i><p class="text-xs font-bold text-gray-800">${r.dificultad}</p></div></div><div class="mb-4 p-3 rounded-xl ${c.faltantes.length===0?'bg-green-50 text-green-700':'bg-orange-50 text-orange-700'} text-xs font-bold flex items-center gap-2"><i class="fas ${c.faltantes.length===0?'fa-check-circle':'fa-shopping-basket'}"></i>${c.faltantes.length===0?'¬°Tienes todo!':`Faltan: ${c.faltantes.map(x=>obtenerNombreIngrediente(x)).join(', ')}`}</div><h3 class="font-bold mb-2 text-sm">Ingredientes</h3><ul class="text-xs space-y-1 mb-4 text-gray-600">${r.ingredientesBase.map(i=>`<li class="flex justify-between items-center"><span>${obtenerNombreIngrediente(i)}</span>${miInventario.has(i)?'<i class="fas fa-check text-green-500"></i>':''}</li>`).join('')}</ul><h3 class="font-bold mb-2 text-sm">Pasos</h3><div class="space-y-2 text-xs text-gray-600">${r.instrucciones.map((p,i)=>`<div class="flex gap-2"><span class="font-bold text-orange-500">${i+1}.</span><p>${p}</p></div>`).join('')}</div><button class="w-full mt-6 btn-magic py-3 rounded-xl font-bold text-xs shadow-lg text-white uppercase tracking-widest" onclick="Swal.close()">Listo</button></div></div>`,
                showConfirmButton: false, padding: 0, width: '100%', customClass: { popup: 'rounded-[24px] overflow-hidden bg-transparent', container: 'p-0 backdrop-blur-sm' }
            });
        }
        async function handleRealAIChat(e) {
            e.preventDefault(); const i = document.getElementById('ai-input'), m = i.value.trim(), c = document.getElementById('chat-messages');
            if(!m) return;
            c.innerHTML += `<div class="flex justify-end mb-3"><div class="chat-bubble-user p-3 text-sm shadow-md text-white max-w-[85%]">${m}</div></div>`;
            i.value=''; c.scrollTop=c.scrollHeight;
            const id = 'typ-'+Date.now(); c.innerHTML += `<div class="flex items-end gap-2 mb-3" id="${id}"><div class="w-6 h-6 rounded-full bg-gray-200"></div><div class="text-xs text-gray-400 italic">Escribiendo...</div></div>`; c.scrollTop=c.scrollHeight;
            const r = await callGeminiAPI(m);
            document.getElementById(id).remove();
            c.innerHTML += `<div class="flex items-end gap-2 mb-3 max-w-[90%]"><div class="w-6 h-6 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 flex-shrink-0 flex items-center justify-center text-[10px] text-white"><i class="fas fa-robot"></i></div><div class="chat-bubble-ai p-3 text-sm shadow-sm text-gray-800 leading-relaxed">${marked.parse(r)}</div></div>`;
            c.scrollTop=c.scrollHeight;
        }
        async function generarRecetaMagica() {
            if(miInventario.size===0) return Swal.fire({icon:'info',title:'Despensa Vac√≠a',text:'Selecciona ingredientes primero.', customClass:{popup:'rounded-[24px]'}});
            Swal.fire({title:'Creando...',didOpen:()=>Swal.showLoading(), allowOutsideClick:false, customClass:{popup:'rounded-[24px]'}});
            const p = `Receta creativa con: ${Array.from(miInventario).map(id=>obtenerNombreIngrediente(id)).join(', ')}. Asume b√°sicos. Nombre, intro y pasos. Markdown.`;
            const r = await callGeminiAPI(p);
            Swal.close();
            Swal.fire({title:'‚ú® Receta M√°gica', html:`<div class="text-left text-sm p-2 max-h-[60vh] overflow-y-auto">${marked.parse(r)}</div>`, confirmButtonText:'¬°Gracias!', customClass:{popup:'rounded-[24px]', confirmButton:'btn-magic rounded-full px-6'}});
        }
        function cargarMasRecetas() { recetasMostradas+=6; renderRecipes(document.getElementById('app-content'), document.querySelector('.bottom-nav-item.active').id==='nav-favorites'?recetasMexicanas.filter(r=>misFavoritos.has(r.id)):null); }
        function limpiarBusqueda() { document.getElementById('global-search').value=''; document.getElementById('global-search').dispatchEvent(new Event('input')); }

        document.getElementById('global-search').addEventListener('input', (e)=>{
            const v=e.target.value.trim(); const active=document.querySelector('.bottom-nav-item.active');
            document.getElementById('clear-search').classList.toggle('hidden', v==='');
            if(v.length>0 && active.id!=='nav-recipes') { router('recipes'); setTimeout(()=>{ const i=document.getElementById('global-search'); i.value=v; i.focus(); }, 50); }
            else if(active.id==='nav-recipes') renderRecipes(document.getElementById('app-content'));
        });

        document.addEventListener('DOMContentLoaded', () => { miInventario.add('tortillas'); miInventario.add('queso'); miInventario.add('huevo'); router('home'); });
    </script>
</body>
</html>
